<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrainLog - Workout Log</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #4a5568;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .header .subtitle {
            text-align: center;
            color: #718096;
            font-size: 1.1rem;
        }

        .nav-bar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4a5568;
        }

        .nav-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .user-label {
            color: #718096;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .user-name {
            color: #4a5568;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .workout-status {
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            animation: pulse 2s infinite;
        }

        .status-label {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .workout-timer {
            font-size: 0.95rem;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .nav-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .nav-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .control-row {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9rem;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            flex: 0 1 auto;
            min-width: 120px;
            text-align: center;
            white-space: nowrap;
        }

        select, input, button {
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .workout-summary {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .summary-title {
            font-size: 1.5rem;
            color: #4a5568;
            font-weight: bold;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-stat {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }

        .summary-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .summary-stat-label {
            color: #718096;
            font-size: 0.9rem;
        }

        .workout-duration {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
        }

        .duration-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .duration-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .timer-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .timer-display {
            font-size: 3rem;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .timer-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .exercise-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .exercise-set {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .exercise-set:hover {
            border-color: #667eea;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.1);
        }

        .exercise-group {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .exercise-group:hover {
            border-color: #667eea;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.1);
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .exercise-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #4a5568;
        }

        .exercise-controls {
            display: flex;
            gap: 8px;
        }

        .exercise-sets {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .exercise-set-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            position: relative;
        }

        .exercise-set-item:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .set-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .set-number {
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9rem;
        }

        .set-controls {
            display: flex;
            gap: 6px;
        }

        .set-controls .btn {
            padding: 4px 8px;
            font-size: 0.8rem;
        }

        .input-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-group label {
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9rem;
        }

        .input-group input {
            width: 100%;
        }

        .rest-timer {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-top: 20px;
            display: none;
        }

        .rest-timer h3 {
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .rest-countdown {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: #fff;
            transition: width 1s linear;
        }

        .rest-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin: 15px 0;
        }

        .rest-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            max-width: 120px;
        }

        .rest-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }

        .rest-btn.complete {
            background: rgba(255, 255, 255, 0.3);
            border-color: #fff;
            font-weight: bold;
        }

        .rest-btn.complete:hover {
            background: rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.3);
        }

        .log-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .log-entry {
            background: #f8fafc;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-entry.pr {
            border-left-color: #f56565;
            background: #fed7d7;
        }

        .pr-badge {
            background: #f56565;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #718096;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .control-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .input-row {
                grid-template-columns: 1fr;
            }
            
            .timer-display {
                font-size: 2rem;
            }
            
            .exercise-controls {
                flex-wrap: wrap;
            }
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

                 .empty-state h3 {
             margin-bottom: 10px;
             color: #4a5568;
         }

         /* History panel styles */
         .history-panel {
             background: rgba(255, 255, 255, 0.95);
             backdrop-filter: blur(10px);
             border-radius: 15px;
             padding: 25px;
             margin-bottom: 20px;
             box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
         }

         .history-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 20px;
         }

         .history-header h3 {
             color: #4a5568;
             font-size: 1.5rem;
             font-weight: bold;
             margin: 0;
         }

         .history-filters {
             display: flex;
             gap: 15px;
             margin-bottom: 20px;
             flex-wrap: wrap;
         }

         .history-records {
             max-height: 400px;
             overflow-y: auto;
         }

         .history-record {
             background: #f8fafc;
             border: 2px solid #e2e8f0;
             border-radius: 12px;
             padding: 15px;
             margin-bottom: 10px;
             transition: all 0.3s ease;
             cursor: pointer;
         }

         .history-record:hover {
             border-color: #667eea;
             box-shadow: 0 4px 20px rgba(102, 126, 234, 0.1);
             transform: translateY(-2px);
         }

         .history-record-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 10px;
         }

         .history-record-title {
             font-weight: bold;
             color: #4a5568;
             font-size: 1.1rem;
         }

         .history-record-date {
             color: #718096;
             font-size: 0.9rem;
         }

         .history-record-details {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
             gap: 10px;
             margin-bottom: 10px;
         }

         .history-record-detail {
             text-align: center;
             padding: 8px;
             background: rgba(102, 126, 234, 0.1);
             border-radius: 8px;
         }

         .history-record-detail-value {
             font-weight: bold;
             color: #667eea;
             font-size: 1.1rem;
         }

         .history-record-detail-label {
             color: #718096;
             font-size: 0.8rem;
         }

         .history-record-actions {
             display: flex;
             gap: 8px;
             justify-content: flex-end;
         }

         .history-record.pr {
             border-left: 4px solid #f56565;
             background: #fed7d7;
         }

         .pr-indicator {
             background: #f56565;
             color: white;
             padding: 2px 6px;
             border-radius: 8px;
             font-size: 0.7rem;
             font-weight: bold;
         }

         /* Date table styles */
         .history-date-group {
             background: #f8fafc;
             border: 2px solid #e2e8f0;
             border-radius: 12px;
             margin-bottom: 15px;
             overflow: hidden;
             transition: all 0.3s ease;
         }

         .history-date-group:hover {
             border-color: #667eea;
             box-shadow: 0 4px 20px rgba(102, 126, 234, 0.1);
         }

         .history-date-header {
             background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
             color: white;
             padding: 15px 20px;
             cursor: pointer;
             display: flex;
             justify-content: space-between;
             align-items: center;
             transition: all 0.3s ease;
         }

         .history-date-header:hover {
             background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
         }

         .history-date-info {
             flex: 1;
         }

         .history-date-title {
             font-size: 1.2rem;
             font-weight: bold;
             margin-bottom: 5px;
         }

         .history-date-summary {
             display: flex;
             gap: 15px;
             font-size: 0.9rem;
             opacity: 0.9;
         }

         .history-date-categories {
             font-weight: 500;
         }

         .history-date-stats {
             opacity: 0.8;
         }

         .history-date-toggle {
             font-size: 1.2rem;
             font-weight: bold;
             transition: transform 0.3s ease;
             cursor: pointer;
             padding: 5px 10px;
             border-radius: 5px;
             background: rgba(255, 255, 255, 0.2);
         }

         .history-date-actions {
             display: flex;
             align-items: center;
             gap: 10px;
         }

         .copy-day-btn {
             background: rgba(255, 255, 255, 0.2) !important;
             border: 1px solid rgba(255, 255, 255, 0.3) !important;
             color: white !important;
             padding: 6px 12px !important;
             font-size: 0.85rem !important;
             border-radius: 6px !important;
             transition: all 0.3s ease !important;
         }

         .copy-day-btn:hover {
             background: rgba(255, 255, 255, 0.3) !important;
             border-color: rgba(255, 255, 255, 0.5) !important;
             transform: translateY(-1px) !important;
         }

         .history-date-details {
             background: white;
             padding: 20px;
         }

         .history-date-records {
             display: flex;
             flex-direction: column;
             gap: 15px;
         }

         .history-date-records .history-record {
             margin-bottom: 0;
             border: 1px solid #e2e8f0;
             background: #fafbfc;
         }

         .history-date-records .history-record:hover {
             border-color: #667eea;
             background: #f7fafc;
         }

         .history-record-time {
             color: #718096;
             font-size: 0.9rem;
         }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🏋️ TrainLog</h1>
            <p class="subtitle">Record every step forward, see every breakthrough</p>
        </div>

        <!-- Navbar -->
        <div class="nav-bar">
            <a href="/main.html" class="nav-btn">🏠 Back to Home</a>
            <h2 class="nav-title">Workout Log</h2>
            <div class="nav-actions">
                <div class="user-info">
                    <span class="user-label">Current user:</span>
                    <span class="user-name" id="currentUser">Loading user...</span>
                </div>
            </div>
        </div>

                 <!-- Control panel -->
         <div class="control-panel">
             <div class="control-row">
                 <div class="form-group">
                     <label>Category</label>
                     <select id="categorySelect" onchange="loadExercises()">
                         <option value="">Select category</option>
                     </select>
                 </div>
                 <div class="form-group">
                     <label>Exercise</label>
                     <select id="exerciseSelect">
                         <option value="">Select exercise</option>
                     </select>
                 </div>
                 <div class="form-group">
                     <label>Quick actions</label>
                     <div class="action-buttons">
                         <button class="btn btn-secondary" onclick="loadMostUsedExercises()">🔥 Most used (me)</button>
                         <button class="btn btn-secondary" onclick="loadPopularExercisesExcludingSelf()">🌟 Popular (others)</button>
                     </div>
                 </div>

                 <div class="form-group">
                     <label>Actions</label>
                     <div class="action-buttons">
                         <button class="btn" onclick="addExerciseSet()">➕ Add set</button>
                         <button class="btn btn-secondary" onclick="loadHistoryRecords()">📚 History</button>
                     </div>
                 </div>
             </div>
         </div>

         <!-- History panel -->
         <div class="history-panel" id="historyPanel" style="display: none;">
             <div class="history-header">
                 <h3>📚 Workout History</h3>
                 <button class="btn btn-secondary" onclick="closeHistoryPanel()">✕ Close</button>
             </div>
             <div class="history-filters">
                 <div class="form-group">
                     <label>Filter by date</label>
                     <select id="dateFilter" onchange="filterHistoryRecords()">
                         <option value="7">Last 7 days</option>
                         <option value="30" selected>Last 30 days</option>
                         <option value="90">Last 90 days</option>
                         <option value="all">All records</option>
                     </select>
                 </div>
                 <div class="form-group">
                     <label>Filter by category</label>
                     <select id="categoryFilter" onchange="filterHistoryRecords()">
                         <option value="">All categories</option>
                     </select>
                 </div>
             </div>
             <div class="history-records" id="historyRecords">
                 <div class="empty-state">
                     <h3>Loading...</h3>
                     <p>Fetching history</p>
                 </div>
             </div>
         </div>

        <!-- Timer -->
        <div class="timer-section">
            <div class="timer-display" id="timer">00:00</div>
            <div class="timer-controls">
                <button class="btn btn-secondary" onclick="startTimer()">Start</button>
                <button class="btn btn-danger" onclick="resetTimer()">Reset</button>
                <button class="btn btn-success" onclick="pauseTimer()">Pause</button>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalSets">0</div>
                <div class="stat-label">Total sets</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalVolume">0</div>
                <div class="stat-label">Total volume (kg)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalReps">0</div>
                <div class="stat-label">Total reps</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="prCount">0</div>
                <div class="stat-label">PRs</div>
            </div>
        </div>

        <!-- Workout summary -->
        <div class="workout-summary" id="workoutSummary">
            <div class="summary-header">
                <div class="summary-title">🎉 Workout Completed!</div>
                <button class="btn btn-secondary" onclick="startNewWorkout()">🔄 Start New Workout</button>
            </div>
            
            <div class="workout-duration">
                <div class="duration-value" id="workoutDuration">00:00</div>
                <div class="duration-label">Duration</div>
            </div>
            
            <div class="summary-stats">
                <div class="summary-stat">
                    <div class="summary-stat-value" id="summarySets">0</div>
                    <div class="summary-stat-label">Sets completed</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value" id="summaryVolume">0</div>
                    <div class="summary-stat-label">Total volume (kg)</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value" id="summaryReps">0</div>
                    <div class="summary-stat-label">Total reps</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value" id="summaryPRs">0</div>
                    <div class="summary-stat-label">PRs</div>
                </div>
            </div>
        </div>

        <!-- Exercise sets container -->
        <div class="exercise-container" id="exerciseContainerSection">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #4a5568; margin: 0;">Exercise Sets</h2>
                <button class="btn btn-success" id="completeWorkoutBtn" onclick="completeWorkout()" style="display: none;">
                    🏁 Complete Workout
                </button>
            </div>
            <div id="exerciseContainer">
                <div class="empty-state">
                    <h3>No sets yet</h3>
                    <p>Click "Add set" to start logging</p>
                </div>
            </div>
        </div>

        <!-- Rest timer -->
        <div class="rest-timer" id="restTimer">
            <h3>💤 Resting</h3>
            <div class="rest-countdown" id="restCountdown">90</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="rest-controls">
                <button class="rest-btn" onclick="adjustRestTime(-10)">-10s</button>
                <button class="rest-btn" onclick="adjustRestTime(10)">+10s</button>
                <button class="rest-btn complete" onclick="completeRest()">Finish rest</button>
            </div>
            <p>Get ready for the next set</p>
        </div>

        <!-- Workout log -->
        <div class="log-section">
            <h2 style="margin-bottom: 20px; color: #4a5568;">Workout Log</h2>
            <div id="logContainer">
                <div class="empty-state">
                    <h3>No workout records yet</h3>
                    <p>After completing sets, records will appear here</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Exercise library - loaded from backend
        let exerciseLibrary = {};

        // Global variables
        let startTime = null;
        let timerInterval = null;
        let isTimerRunning = false;
        let restInterval = null;
        let currentRestSeconds = 0; // current rest seconds
        let totalRestSeconds = 0; // total rest seconds (for progress bar)
        let totalSets = 0;
        let totalVolume = 0;
        let totalReps = 0;
        let prCount = 0;
        let completedSets = 0;
        let workoutCompleted = false;
        let currentUsername = null; // current logged in username

        // Init page
        document.addEventListener('DOMContentLoaded', function() {
            // Load current user
            loadCurrentUser();
            loadExerciseLibrary();
            updateStats();
            
            // Hide summary
            document.getElementById('workoutSummary').style.display = 'none';
        });

        // Load current user
        function loadCurrentUser() {
            // From localStorage
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (loggedInUser) {
                try {
                    const userData = JSON.parse(loggedInUser);
                    currentUsername = userData.username;
                    document.getElementById('currentUser').textContent = currentUsername;
                } catch (e) {
                    console.error('Failed to parse user info:', e);
                    currentUsername = 'testuser'; // default username
                    document.getElementById('currentUser').textContent = currentUsername;
                }
            } else {
                // If no login info, use default
                currentUsername = 'testuser';
                document.getElementById('currentUser').textContent = currentUsername;
            }
        }




        // By myself
        // Load exercise library from backend
        function loadExerciseLibrary() {
            fetch('/api/exercises')
                .then(res => res.json())
                .then(exercises => {
                    // Group by category
                    exerciseLibrary = {};
                    exercises.forEach(exercise => {
                        if (!exerciseLibrary[exercise.category]) {
                            exerciseLibrary[exercise.category] = [];
                        }
                        exerciseLibrary[exercise.category].push({
                            id: exercise.id,
                            name: exercise.name
                        });
                    });
                    
                    // Initialize category select
                    initializeCategorySelect();
                    loadExercises();
                })
                .catch(error => {
                    console.error('Error loading exercise library:', error);
                    alert('Failed to load exercise library. Please refresh and try again.');
                });
        }

        // By myself
        // Initialize category select
        function initializeCategorySelect() {
            const categorySelect = document.getElementById("categorySelect");
            categorySelect.innerHTML = '<option value="">Select category</option>';
            
            for (const category in exerciseLibrary) {
                const option = document.createElement("option");
                option.value = category;
                option.text = category;
                categorySelect.appendChild(option);
            }
        }

        // By myself
        // Load exercises
        function loadExercises() {
            const categorySelect = document.getElementById("categorySelect");
            const exerciseSelect = document.getElementById("exerciseSelect");
            const selectedCategory = categorySelect.value;
            
            exerciseSelect.innerHTML = '<option value="">Select exercise</option>';
            
            if (selectedCategory && exerciseLibrary[selectedCategory]) {
                exerciseLibrary[selectedCategory].forEach(ex => {
                    const option = document.createElement("option");
                    option.value = ex.id;
                    option.text = ex.name;
                    exerciseSelect.appendChild(option);
                });
            }
        }

        // By myself
        // Load most used exercises
        function loadMostUsedExercises() {
            const categorySelect = document.getElementById("categorySelect");
            const selectedCategory = categorySelect.value;
            
            if (!currentUsername) {
                alert('Please log in first');
                return;
            }
            
            if (!selectedCategory) {
                alert('Please select a category first');
                return;
            }

            // Show loading state
            const exerciseSelect = document.getElementById("exerciseSelect");
            exerciseSelect.innerHTML = '<option value="">Loading...</option>';

            // Fetch most used
            fetch(`/api/workouts/most-used?username=${currentUsername}&category=${selectedCategory}`)
                .then(res => res.json())
                .then(exercises => {
                    exerciseSelect.innerHTML = '<option value="">Select exercise</option>';
                    
                    if (exercises.length === 0) {
                        // If no history, load default
                        loadExercises();
                        alert('No history found. Loaded default exercises');
                    } else {
                        // Show most used and mark order
                        exercises.forEach((exercise, index) => {
                            const option = document.createElement("option");
                            option.value = exercise.id;
                            option.text = `${exercise.name} (#${index + 1} most used)`;
                            exerciseSelect.appendChild(option);
                        });
                        
                        // Auto-select the first (most used)
                        if (exercises.length > 0) {
                            exerciseSelect.value = exercises[0].id;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading most used exercises:', error);
                    exerciseSelect.innerHTML = '<option value="">Failed to load</option>';
                    alert('Failed to load most used exercises, please retry');
                });
        }

        // By myself
        // Load popular exercises (by category, excluding current user)
        function loadPopularExercisesExcludingSelf() {
            const categorySelect = document.getElementById("categorySelect");
            const selectedCategory = categorySelect.value;

            if (!currentUsername) {
                alert('Please log in first');
                return;
            }

            if (!selectedCategory) {
                alert('Please select a category first');
                return;
            }

            const exerciseSelect = document.getElementById("exerciseSelect");
            exerciseSelect.innerHTML = '<option value="">Loading...</option>';

            fetch(`/api/workouts/popular-exclude-self?category=${selectedCategory}&username=${currentUsername}`)
                .then(res => res.json())
                .then(exercises => {
                    exerciseSelect.innerHTML = '<option value="">Select exercise</option>';

                    if (exercises.length === 0) {
                        alert('No popular exercises, loaded all exercises for this category');
                        loadExercises();
                    } else {
                        exercises.forEach((exercise, index) => {
                            const option = document.createElement("option");
                            option.value = exercise.id;
                            option.text = `${exercise.name} (#${index + 1} popular)`;
                            exerciseSelect.appendChild(option);
                        });

                        if (exercises.length > 0) {
                            exerciseSelect.value = exercises[0].id;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading popular exercises:', error);
                    exerciseSelect.innerHTML = '<option value="">Failed to load</option>';
                    alert('Failed to load popular exercises, please retry');
                });
        }

        // By myself
        // Add exercise set
        function addExerciseSet() {
            const categorySelect = document.getElementById("categorySelect");
            const exerciseSelect = document.getElementById("exerciseSelect");
            
            if (!categorySelect.value || !exerciseSelect.value) {
                alert('Please select category and exercise');
                return;
            }
            
            if (!currentUsername) {
                alert('Please log in first');
                return;
            }

            const selectedExerciseId = exerciseSelect.value;
            const selectedExerciseName = exerciseSelect.options[exerciseSelect.selectedIndex].text;
            const container = document.getElementById("exerciseContainer");
            
            console.log('Add set - exerciseId:', selectedExerciseId, 'name:', selectedExerciseName);
            
            // Remove empty state
            if (container.querySelector('.empty-state')) {
                container.innerHTML = '';
            }

            // Check if group for exercise already exists
            let existingGroup = null;
            const existingGroups = container.querySelectorAll('.exercise-group');
            
            console.log('Existing exercise group count:', existingGroups.length);
            
            for (let group of existingGroups) {
                const groupExerciseId = group.querySelector('.exercise-id').value;
                console.log('Check group exerciseId:', groupExerciseId, 'matches:', groupExerciseId === selectedExerciseId);
                if (groupExerciseId === selectedExerciseId) {
                    existingGroup = group;
                    console.log('Found existing group, will add new set');
                    break;
                }
            }

            if (existingGroup) {
                // If exists, add new set to existing group
                console.log('Adding new set to existing group');
                const setsContainer = existingGroup.querySelector('.exercise-sets');
                const setCount = setsContainer.children.length + 1;
                
                const setItem = document.createElement("div");
                setItem.className = "exercise-set-item";
                setItem.innerHTML = `
                    <div class="set-header">
                        <div class="set-number">Set ${setCount}</div>
                        <div class="set-controls">
                            <button class="btn btn-success log-btn" onclick="logWorkout(this)">✅ Log</button>
                            <button class="btn btn-secondary" onclick="duplicateSet(this)">📋 Duplicate</button>
                            <button class="btn btn-danger" onclick="deleteSet(this)">🗑️ Delete</button>
                        </div>
                    </div>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Weight (kg)</label>
                            <input type="number" class="weight" value="60" min="0" step="0.5">
                        </div>
                        <div class="input-group">
                            <label>Reps</label>
                            <input type="number" class="reps" value="8" min="1">
                        </div>
                        <div class="input-group">
                            <label>Rest (s)</label>
                            <input type="number" class="rest" value="90" min="0">
                        </div>
                        <div class="input-group">
                            <label>Notes</label>
                            <input type="text" class="notes" placeholder="Optional notes">
                        </div>
                    </div>
                `;
                
                setsContainer.appendChild(setItem);
            } else {
                // Create a new exercise group
                console.log('No existing group found, creating a new group');
                const groupDiv = document.createElement("div");
                groupDiv.className = "exercise-group";
                groupDiv.innerHTML = `
                    <div class="exercise-header">
                        <div class="exercise-name">${selectedExerciseName}</div>
                        <div class="exercise-controls">
                            <button class="btn btn-secondary" onclick="duplicateExerciseGroup(this)">📋 Duplicate exercise</button>
                            <button class="btn btn-danger" onclick="deleteExerciseGroup(this)">🗑️ Delete exercise</button>
                        </div>
                    </div>
                    <div class="exercise-sets">
                        <div class="exercise-set-item">
                            <div class="set-header">
                                <div class="set-number">Set 1</div>
                                <div class="set-controls">
                                    <button class="btn btn-success log-btn" onclick="logWorkout(this)">✅ Log</button>
                                    <button class="btn btn-secondary" onclick="duplicateSet(this)">📋 Duplicate</button>
                                    <button class="btn btn-danger" onclick="deleteSet(this)">🗑️ Delete</button>
                                </div>
                            </div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label>Weight (kg)</label>
                                    <input type="number" class="weight" value="60" min="0" step="0.5">
                                </div>
                                <div class="input-group">
                                    <label>Reps</label>
                                    <input type="number" class="reps" value="8" min="1">
                                </div>
                                <div class="input-group">
                                    <label>Rest (s)</label>
                                    <input type="number" class="rest" value="90" min="0">
                                </div>
                                <div class="input-group">
                                    <label>Notes</label>
                                    <input type="text" class="notes" placeholder="Optional notes">
                                </div>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" class="exercise-id" value="${selectedExerciseId}">
                `;
                
                container.appendChild(groupDiv);
            }
            
            totalSets++;
            updateStats();
            
            // Show complete button
            document.getElementById('completeWorkoutBtn').style.display = 'block';
            

        }

        // By myself
        // Log workout
        function logWorkout(button) {
            const setItem = button.closest('.exercise-set-item');
            const exerciseGroup = button.closest('.exercise-group');
            const exerciseId = exerciseGroup.querySelector('.exercise-id').value;
            const weight = parseFloat(setItem.querySelector('.weight').value);
            const reps = parseInt(setItem.querySelector('.reps').value);
            const rest = parseInt(setItem.querySelector('.rest').value);
            const notes = setItem.querySelector('.notes').value;

            if (!currentUsername || !exerciseId || weight <= 0 || reps <= 0) {
                alert('Please complete all workout fields');
                return;
            }

            // Auto-start timer on first log
            if (completedSets === 0) {
                startTimer();
            }

            // Start rest countdown
            if (rest > 0) {
                startRestCountdown(rest);
            }

            // Send to backend
            fetch(`/api/workouts/log?username=${currentUsername}&exerciseId=${exerciseId}&weight=${weight}&reps=${reps}&restSeconds=${rest}`, {
                method: 'POST'
            })
            .then(res => {
                if (!res.ok) {
                    return res.text().then(text => {
                        throw new Error(text);
                    });
                }
                return res.json();
            })
            .then(data => {
                addLogEntry(data, notes);
                updateVolumeStats(weight, reps, data.personalRecord);
                completedSets++;
                
                // Disable log button only, keep duplicate and delete enabled
                const logBtn = setItem.querySelector('.log-btn');
                if (logBtn) {
                    logBtn.disabled = true;
                    logBtn.textContent = '✅ Logged';
                    logBtn.style.opacity = '0.6';
                    logBtn.style.cursor = 'not-allowed';
                }
                

            })
            .catch(error => {
                console.error('Error:', error);
                alert('Logging failed: ' + error.message);
            });
        }

        // By myself
        // Add log entry
        function addLogEntry(data, notes) {
            const container = document.getElementById("logContainer");
            
            // Remove empty state
            if (container.querySelector('.empty-state')) {
                container.innerHTML = '';
            }

            const logDiv = document.createElement("div");
            logDiv.className = `log-entry ${data.personalRecord ? 'pr' : ''}`;
            
            const time = new Date().toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            logDiv.innerHTML = `
                <div>
                    <strong>${data.exercise.name}</strong> - ${data.weight}kg × ${data.reps} reps
                    ${notes ? `<br><small>Notes: ${notes}</small>` : ''}
                    <br><small>Time: ${time}</small>
                </div>
                <div>
                    ${data.personalRecord ? '<span class="pr-badge">🏆 PR!</span>' : ''}
                </div>
            `;
            
            container.insertBefore(logDiv, container.firstChild);
        }

        // By myself
        // Duplicate set
        function duplicateSet(button) {
            const currentSetItem = button.closest('.exercise-set-item');
            const exerciseGroup = button.closest('.exercise-group');
            const setsContainer = exerciseGroup.querySelector('.exercise-sets');
            const newSetItem = currentSetItem.cloneNode(true);
            
            // Reset values for new set
            newSetItem.querySelector('.weight').value = currentSetItem.querySelector('.weight').value;
            newSetItem.querySelector('.reps').value = currentSetItem.querySelector('.reps').value;
            newSetItem.querySelector('.rest').value = currentSetItem.querySelector('.rest').value;
            newSetItem.querySelector('.notes').value = '';
            
            // Reset log button
            const logBtn = newSetItem.querySelector('.log-btn');
            if (logBtn) {
                logBtn.disabled = false;
                logBtn.textContent = '✅ Log';
                logBtn.style.opacity = '1';
                logBtn.style.cursor = 'pointer';
            }
            
            // Update set number
            const setCount = setsContainer.children.length + 1;
            newSetItem.querySelector('.set-number').textContent = `Set ${setCount}`;
            
            // Append to current exercise group
            setsContainer.appendChild(newSetItem);
            
            totalSets++;
            updateStats();
        }

        // By myself
        // Delete set
        function deleteSet(button) {
            const setItem = button.closest('.exercise-set-item');
            const exerciseGroup = button.closest('.exercise-group');
            const setsContainer = exerciseGroup.querySelector('.exercise-sets');
            
            setItem.remove();
            totalSets--;
            updateStats();
            
            // Re-number remaining sets
            const setItems = setsContainer.querySelectorAll('.exercise-set-item');
            setItems.forEach((item, index) => {
                item.querySelector('.set-number').textContent = `Set ${index + 1}`;
            });
            
            // If there is no set for the exercise, remove the entire group
            if (setsContainer.children.length === 0) {
                exerciseGroup.remove();
            }
            
            // If no sets left, show empty state and hide complete button
            const container = document.getElementById("exerciseContainer");
            if (container.children.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No sets yet</h3>
                        <p>Click "Add set" to start logging</p>
                    </div>
                `;
                document.getElementById('completeWorkoutBtn').style.display = 'none';
            }
        }

        // Duplicate entire exercise group
        function duplicateExerciseGroup(button) {
            const exerciseGroup = button.closest('.exercise-group');
            const container = document.getElementById("exerciseContainer");
            const newGroup = exerciseGroup.cloneNode(true);
            
            // Reset sets' states
            const setItems = newGroup.querySelectorAll('.exercise-set-item');
            setItems.forEach((item, index) => {
                // Reset log button
                const logBtn = item.querySelector('.log-btn');
                if (logBtn) {
                    logBtn.disabled = false;
                    logBtn.textContent = '✅ Log';
                    logBtn.style.opacity = '1';
                    logBtn.style.cursor = 'pointer';
                }
                
                // Clear notes
                item.querySelector('.notes').value = '';
                
                // Update set number
                item.querySelector('.set-number').textContent = `Set ${index + 1}`;
            });
            
            // Append to container
            container.appendChild(newGroup);
            
            // Update total sets
            totalSets += setItems.length;
            updateStats();
        }

        // By myself
        // Delete entire exercise group
        function deleteExerciseGroup(button) {
            const exerciseGroup = button.closest('.exercise-group');
            const setItems = exerciseGroup.querySelectorAll('.exercise-set-item');
            
            exerciseGroup.remove();
            totalSets -= setItems.length;
            updateStats();
            
            // If no sets left, show empty state and hide complete button
            const container = document.getElementById("exerciseContainer");
            if (container.children.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No sets yet</h3>
                        <p>Click "Add set" to start logging</p>
                    </div>
                `;
                document.getElementById('completeWorkoutBtn').style.display = 'none';
            }
        }

        // By myself
        // Start rest countdown
        function startRestCountdown(seconds) {
            const restTimer = document.getElementById("restTimer");
            const countdownSpan = document.getElementById("restCountdown");
            const progressFill = document.getElementById("progressFill");
            
            // Clear previous timer
            if (restInterval) {
                clearInterval(restInterval);
            }
            
            restTimer.style.display = "block";
            currentRestSeconds = seconds;
            totalRestSeconds = seconds;
            countdownSpan.innerText = seconds;
            progressFill.style.width = "100%";
            
            restInterval = setInterval(() => {
                currentRestSeconds--;
                countdownSpan.innerText = currentRestSeconds;
                progressFill.style.width = `${(currentRestSeconds / totalRestSeconds) * 100}%`;
                
                if (currentRestSeconds <= 0) {
                    clearInterval(restInterval);
                    restTimer.style.display = "none";
                    
            // Notify when rest is over
                    if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Rest is over!', { body: 'Get ready for the next set' });
                    } else {
                alert("✅ Rest finished. Get ready for the next set!");
                    }
                }
            }, 1000);
        }

        // By myself
        // Adjust rest time
        function adjustRestTime(adjustment) {
            if (restInterval) {
                currentRestSeconds += adjustment;
                
                // Ensure non-negative time
                if (currentRestSeconds < 0) {
                    currentRestSeconds = 0;
                }
                
                // Update UI
                const countdownSpan = document.getElementById("restCountdown");
                const progressFill = document.getElementById("progressFill");
                
                countdownSpan.innerText = currentRestSeconds;
                progressFill.style.width = `${(currentRestSeconds / totalRestSeconds) * 100}%`;
                
                // If timer hits zero, end rest
                if (currentRestSeconds <= 0) {
                    completeRest();
                }
            }
        }

        // By myself
        // Complete rest
             function completeRest() {
                 if (restInterval) {
                     clearInterval(restInterval);
                     restInterval = null;
                 }
                 
                 const restTimer = document.getElementById("restTimer");
                 restTimer.style.display = "none";
             }

        // By myself
        // Timer functions
        function startTimer() {
            if (!isTimerRunning) {
                if (!startTime) {
                    startTime = Date.now();
                }
                isTimerRunning = true;
                timerInterval = setInterval(updateTimer, 1000);
            }
        }

        // By myself
        function pauseTimer() {
            if (isTimerRunning) {
                clearInterval(timerInterval);
                isTimerRunning = false;
            }
        }

        // By myself
        function resetTimer() {
            clearInterval(timerInterval);
            startTime = null;
            isTimerRunning = false;
            document.getElementById("timer").innerText = "00:00";
        }

        // By myself
        function updateTimer() {
            if (startTime) {
                const diff = Date.now() - startTime;
                const mins = String(Math.floor(diff / 60000)).padStart(2, '0');
                const secs = String(Math.floor((diff % 60000) / 1000)).padStart(2, '0');
                document.getElementById("timer").innerText = `${mins}:${secs}`;
            }
        }

        // By myself
        // Update volume stats
        function updateVolumeStats(weight, reps, isPR) {
            totalVolume += weight * reps;
            totalReps += reps;
            if (isPR) {
                prCount++;
            }
            updateStats();
        }

        function updateStats() {
            document.getElementById("totalSets").innerText = totalSets;
            document.getElementById("totalVolume").innerText = totalVolume.toLocaleString();
            document.getElementById("totalReps").innerText = totalReps.toLocaleString();
            document.getElementById("prCount").innerText = prCount;
        }


        // By myself
        // Complete workout
        function completeWorkout() {
            if (totalSets === 0) {
                alert('Please add at least one set');
                return;
            }

            if (completedSets === 0) {
                alert('Please complete at least one set');
                return;
            }

            // Stop timer and compute duration
            pauseTimer();
            let durationText = "00:00";
            if (startTime) {
                const diff = Date.now() - startTime;
                const mins = String(Math.floor(diff / 60000)).padStart(2, '0');
                const secs = String(Math.floor((diff % 60000) / 1000)).padStart(2, '0');
                durationText = `${mins}:${secs}`;
            }

            // Update summary
            document.getElementById('workoutDuration').textContent = durationText;
            document.getElementById('summarySets').textContent = completedSets;
            document.getElementById('summaryVolume').textContent = totalVolume.toLocaleString();
            document.getElementById('summaryReps').textContent = totalReps.toLocaleString();
            document.getElementById('summaryPRs').textContent = prCount;

            // Show summary and hide sets section
            document.getElementById('workoutSummary').style.display = 'block';
            document.getElementById('exerciseContainerSection').style.display = 'none';
            document.getElementById('completeWorkoutBtn').style.display = 'none';

            // Save workout session to backend
            saveWorkoutSession(durationText);

            workoutCompleted = true;

            // Show success message
            alert(`🎉 Workout completed!\nDuration: ${durationText}\nSets: ${completedSets}\nTotal Volume: ${totalVolume.toLocaleString()}kg\nPRs: ${prCount}`);
        }

        // By myself
        // Start new workout
        function startNewWorkout() {
            // Reset all data
            resetWorkoutData();
            
            // Reset timer
            resetTimer();
            
            // Hide summary and show sets
            document.getElementById('workoutSummary').style.display = 'none';
            document.getElementById('exerciseContainerSection').style.display = 'block';
            
            // Clear sets and logs
            document.getElementById('exerciseContainer').innerHTML = `
                <div class="empty-state">
                    <h3>No sets yet</h3>
                    <p>Click "Add set" to start logging</p>
                </div>
            `;
            document.getElementById('logContainer').innerHTML = `
                <div class="empty-state">
                    <h3>No workout records yet</h3>
                    <p>After completing sets, records will appear here</p>
                </div>
            `;
            

            

        }

        // Reset workout data
        function resetWorkoutData() {
            totalSets = 0;
            totalVolume = 0;
            totalReps = 0;
            prCount = 0;
            completedSets = 0;
            workoutCompleted = false;
            // Reset timer variables
            startTime = null;
            isTimerRunning = false;
            // Reset rest timer variables
            if (restInterval) {
                clearInterval(restInterval);
                restInterval = null;
            }
            currentRestSeconds = 0;
            totalRestSeconds = 0;
            updateStats();
        }

        // Save workout session
        function saveWorkoutSession(duration) {
            if (!currentUsername) {
                console.error('Username cannot be empty');
                return;
            }

            const workoutData = {
                username: currentUsername,
                duration: duration,
                totalSets: completedSets,
                totalVolume: totalVolume,
                totalReps: totalReps,
                prCount: prCount,
                startTime: Date.now(),
                endTime: Date.now()
            };

            // Send to backend to save session
            fetch('/api/workouts/session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(workoutData)
            })
            .then(res => res.text())
            .then(result => {
                console.log('Workout session saved:', result);
            })
            .catch(error => {
                console.error('Failed to save workout session:', error);
            });
        }

         // Request notification permission
         if ('Notification' in window) {
             Notification.requestPermission();
         }

        // By myself
         // History related variables
         let historyRecords = [];
         let filteredHistoryRecords = [];

         // Load history
         function loadHistoryRecords() {
             if (!currentUsername) {
                 alert('Please log in first');
                 return;
             }

             document.getElementById('historyPanel').style.display = 'block';
             
             // Show loading state
             document.getElementById('historyRecords').innerHTML = `
                 <div class="empty-state">
                     <h3>Loading...</h3>
                     <p>Fetching history</p>
                 </div>
             `;

             // Fetch history
             fetch(`/api/workouts/history?username=${currentUsername}`)
                 .then(res => res.json())
                 .then(records => {
                     historyRecords = records;
                     filteredHistoryRecords = records;
                     
                     // Initialize filters
                     initializeHistoryFilters();
                     
                     // Display records
                     displayHistoryRecords();
                 })
                 .catch(error => {
                     console.error('Error loading history records:', error);
                     document.getElementById('historyRecords').innerHTML = `
                         <div class="empty-state">
                             <h3>Load failed</h3>
                             <p>Unable to fetch history, please retry</p>
                         </div>
                     `;
                 });
         }

         // Close history panel
         function closeHistoryPanel() {
             document.getElementById('historyPanel').style.display = 'none';
         }

         // Initialize history filters
         function initializeHistoryFilters() {
             // Initialize category filter
             const categoryFilter = document.getElementById('categoryFilter');
             const categories = [...new Set(historyRecords.map(record => record.exercise.category))];
             
            categoryFilter.innerHTML = '<option value="">All categories</option>';
             categories.forEach(category => {
                 const option = document.createElement('option');
                 option.value = category;
                 option.text = category;
                 categoryFilter.appendChild(option);
             });
         }

         // Filter history
         function filterHistoryRecords() {
             const dateFilter = document.getElementById('dateFilter').value;
             const categoryFilter = document.getElementById('categoryFilter').value;
             
             let filtered = historyRecords;
             
             // Filter by date
             if (dateFilter !== 'all') {
                 const days = parseInt(dateFilter);
                 const cutoffDate = new Date();
                 cutoffDate.setDate(cutoffDate.getDate() - days);
                 
                 filtered = filtered.filter(record => {
                     const recordDate = new Date(record.timestamp);
                     return recordDate >= cutoffDate;
                 });
             }
             
             // Filter by category
             if (categoryFilter) {
                 filtered = filtered.filter(record => record.exercise.category === categoryFilter);
             }
             
             filteredHistoryRecords = filtered;
             displayHistoryRecords();
         }

         // Display history - date table view
         function displayHistoryRecords() {
             const container = document.getElementById('historyRecords');
             
             if (filteredHistoryRecords.length === 0) {
                 container.innerHTML = `
                     <div class="empty-state">
                         <h3>No records found</h3>
                         <p>No history matches the current filters</p>
                     </div>
                 `;
                 return;
             }
             
             // Group by date
             const recordsByDate = groupRecordsByDate(filteredHistoryRecords);
             
             container.innerHTML = '';
             
             // Build date table
             Object.keys(recordsByDate).sort((a, b) => new Date(b) - new Date(a)).forEach(date => {
                 const dateDiv = document.createElement('div');
                 dateDiv.className = 'history-date-group';
                 
                 const records = recordsByDate[date];
                 const categories = [...new Set(records.map(r => r.exercise.category))];
                 const totalSets = records.length;
                 const totalVolume = records.reduce((sum, r) => sum + (r.weight * r.reps), 0);
                 
                 const dateObj = new Date(date);
                 const dateStr = dateObj.toLocaleDateString('en-US', { 
                     year: 'numeric', 
                     month: 'long', 
                     day: 'numeric',
                     weekday: 'long'
                 });
                 
                 dateDiv.innerHTML = `
                     <div class="history-date-header">
                             <div class="history-date-info" onclick="toggleDateDetails('${date}')">
                              <div class="history-date-title">${dateStr}</div>
                              <div class="history-date-summary">
                                  <span class="history-date-categories">${categories.join(', ')}</span>
                                  <span class="history-date-stats">${totalSets} sets · ${totalVolume.toFixed(0)}kg</span>
                              </div>
                         </div>
                         <div class="history-date-actions">
                              <button class="btn btn-primary copy-day-btn" onclick="copyEntireDay('${date}', event)">
                                  📋 Copy entire day
                             </button>
                             <div class="history-date-toggle" onclick="toggleDateDetails('${date}')">▼</div>
                         </div>
                     </div>
                     <div class="history-date-details" id="dateDetails_${date}" style="display: none;">
                         <div class="history-date-records">
                             ${records.map(record => {
                                 const recordDate = new Date(record.timestamp);
                                  const timeStr = recordDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                                 
                                 return `
                                     <div class="history-record ${record.personalRecord ? 'pr' : ''}">
                                         <div class="history-record-header">
                                             <div class="history-record-title">
                                                 ${record.exercise.name}
                                                 ${record.personalRecord ? '<span class="pr-indicator">🏆 PR</span>' : ''}
                                             </div>
                                             <div class="history-record-time">${timeStr}</div>
                                         </div>
                                         <div class="history-record-details">
                                             <div class="history-record-detail">
                                                 <div class="history-record-detail-value">${record.weight}</div>
                                                  <div class="history-record-detail-label">Weight (kg)</div>
                                             </div>
                                             <div class="history-record-detail">
                                                 <div class="history-record-detail-value">${record.reps}</div>
                                                  <div class="history-record-detail-label">Reps</div>
                                             </div>
                                             <div class="history-record-detail">
                                                 <div class="history-record-detail-value">${record.exercise.category}</div>
                                                  <div class="history-record-detail-label">Category</div>
                                             </div>
                                             <div class="history-record-detail">
                                                 <div class="history-record-detail-value">${record.restSeconds || 0}</div>
                                                  <div class="history-record-detail-label">Rest (s)</div>
                                             </div>
                                         </div>
                                         <div class="history-record-actions">
                                              <button class="btn btn-success" onclick="copyHistoryRecord(${record.exercise.id}, '${record.exercise.name}', ${record.weight}, ${record.reps}, ${record.restSeconds || 0})">
                                                  📋 Copy to today
                                             </button>
                                         </div>
                                     </div>
                                 `;
                             }).join('')}
                         </div>
                     </div>
                 `;
                 
                 container.appendChild(dateDiv);
             });
         }
         
        // Group records by date
         function groupRecordsByDate(records) {
             const grouped = {};
             
             records.forEach(record => {
                 const date = new Date(record.timestamp);
                const dateKey = date.toISOString().split('T')[0]; // YYYY-MM-DD format
                 
                 if (!grouped[dateKey]) {
                     grouped[dateKey] = [];
                 }
                 
                 grouped[dateKey].push(record);
             });
             
             return grouped;
         }
         
        // Toggle date details
         function toggleDateDetails(date) {
             const detailsDiv = document.getElementById(`dateDetails_${date}`);
             const header = detailsDiv.previousElementSibling;
             const toggle = header.querySelector('.history-date-toggle');
             
             if (detailsDiv.style.display === 'none') {
                 detailsDiv.style.display = 'block';
                 toggle.textContent = '▲';
             } else {
                 detailsDiv.style.display = 'none';
                 toggle.textContent = '▼';
             }
         }

        // Use ChatGpt to learn the logic for this function
            // Copy entire day to today
         function copyEntireDay(date, event) {
            event.stopPropagation(); // prevent event bubbling
             
             const recordsByDate = groupRecordsByDate(filteredHistoryRecords);
             const dayRecords = recordsByDate[date];
             
             if (!dayRecords || dayRecords.length === 0) {
                alert('❌ No workout records found for that date');
                 return;
             }
             
            // Confirm copy
            const confirmMessage = `Copy all workouts on ${date} to today?\n\nTotal sets: ${dayRecords.length}`;
             if (!confirm(confirmMessage)) {
                 return;
             }
             
            // Get workout container
             const container = document.getElementById("exerciseContainer");
             
            // Remove empty state
             if (container.querySelector('.empty-state')) {
                 container.innerHTML = '';
             }
             
             let addedSets = 0;
             
            // Group by exercise
             const exerciseGroups = {};
             dayRecords.forEach((record, index) => {
                 const exercise = record.exercise;
                 if (!exerciseGroups[exercise.id]) {
                     exerciseGroups[exercise.id] = {
                         exercise: exercise,
                         sets: []
                     };
                 }
                 exerciseGroups[exercise.id].sets.push(record);
             });
             
            // Create a group for each exercise
             Object.values(exerciseGroups).forEach(group => {
                 const exercise = group.exercise;
                 const sets = group.sets;
                 
                // Create exercise group
                 const groupDiv = document.createElement("div");
                 groupDiv.className = "exercise-group";
                 
                // Build inner HTML
                 let setsHTML = '';
                 sets.forEach((record, index) => {
                     setsHTML += `
                         <div class="exercise-set-item">
                             <div class="set-header">
                                <div class="set-number">Set ${index + 1}</div>
                                 <div class="set-controls">
                                    <button class="btn btn-success log-btn" onclick="logWorkout(this)">✅ Log</button>
                                    <button class="btn btn-secondary" onclick="duplicateSet(this)">📋 Duplicate</button>
                                    <button class="btn btn-danger" onclick="deleteSet(this)">🗑️ Delete</button>
                                 </div>
                             </div>
                             <div class="input-row">
                                 <div class="input-group">
                                    <label>Weight (kg)</label>
                                     <input type="number" class="weight" value="${record.weight}" min="0" step="0.5">
                                 </div>
                                 <div class="input-group">
                                    <label>Reps</label>
                                     <input type="number" class="reps" value="${record.reps}" min="1">
                                 </div>
                                 <div class="input-group">
                                    <label>Rest (s)</label>
                                     <input type="number" class="rest" value="${record.restSeconds || 0}" min="0">
                                 </div>
                                 <div class="input-group">
                                    <label>Notes</label>
                                    <input type="text" class="notes" placeholder="Optional notes">
                                 </div>
                             </div>
                         </div>
                     `;
                 });
                 
                 groupDiv.innerHTML = `
                     <div class="exercise-header">
                         <div class="exercise-name">${exercise.name}</div>
                         <div class="exercise-controls">
                            <button class="btn btn-secondary" onclick="duplicateExerciseGroup(this)">📋 Duplicate exercise</button>
                            <button class="btn btn-danger" onclick="deleteExerciseGroup(this)">🗑️ Delete exercise</button>
                         </div>
                     </div>
                     <div class="exercise-sets">
                         ${setsHTML}
                     </div>
                     <input type="hidden" class="exercise-id" value="${exercise.id}">
                 `;
                 
                 container.appendChild(groupDiv);
                 addedSets += sets.length;
             });
             
            // Update stats
             totalSets += addedSets;
             updateStats();
             
            // Show complete button
             document.getElementById('completeWorkoutBtn').style.display = 'block';
             
            // If first group, start timer

             
            // Close history panel
             closeHistoryPanel();
             
            // Show success message
            alert(`✅ Entire day copied!\n\nDate: ${date}\nSets copied: ${addedSets}\n\nYou can start today's workout now!`);
         }

          // Copy a history record to today's workout
         function copyHistoryRecord(exerciseId, exerciseName, weight, reps, restSeconds) {
              // Set category and exercise selectors
             const categorySelect = document.getElementById('categorySelect');
             const exerciseSelect = document.getElementById('exerciseSelect');
             
              // Find corresponding category
             const exercise = historyRecords.find(r => r.exercise.id === exerciseId)?.exercise;
             if (exercise) {
                 categorySelect.value = exercise.category;
                 loadExercises();
                 
                  // Set after exercises are loaded
                 setTimeout(() => {
                     exerciseSelect.value = exerciseId;
                     
                    // Create exercise group
                     const container = document.getElementById("exerciseContainer");
                     
                    // Remove empty state
                     if (container.querySelector('.empty-state')) {
                         container.innerHTML = '';
                     }

                    // Check if group already exists for this exercise
                     let existingGroup = null;
                     const existingGroups = container.querySelectorAll('.exercise-group');
                     
                     for (let group of existingGroups) {
                         const groupExerciseId = group.querySelector('.exercise-id').value;
                         if (groupExerciseId === exerciseId) {
                             existingGroup = group;
                             break;
                         }
                     }

                     if (existingGroup) {
                        // If exists, add a new set
                         const setsContainer = existingGroup.querySelector('.exercise-sets');
                         const setCount = setsContainer.children.length + 1;
                         
                         const setItem = document.createElement("div");
                         setItem.className = "exercise-set-item";
                         setItem.innerHTML = `
                             <div class="set-header">
                                <div class="set-number">Set ${setCount}</div>
                                 <div class="set-controls">
                                    <button class="btn btn-success log-btn" onclick="logWorkout(this)">✅ Log</button>
                                    <button class="btn btn-secondary" onclick="duplicateSet(this)">📋 Duplicate</button>
                                    <button class="btn btn-danger" onclick="deleteSet(this)">🗑️ Delete</button>
                                 </div>
                             </div>
                             <div class="input-row">
                                 <div class="input-group">
                                    <label>Weight (kg)</label>
                                     <input type="number" class="weight" value="${weight}" min="0" step="0.5">
                                 </div>
                                 <div class="input-group">
                                    <label>Reps</label>
                                     <input type="number" class="reps" value="${reps}" min="1">
                                 </div>
                                 <div class="input-group">
                                    <label>Rest (s)</label>
                                     <input type="number" class="rest" value="${restSeconds}" min="0">
                                 </div>
                                 <div class="input-group">
                                    <label>Notes</label>
                                    <input type="text" class="notes" placeholder="Optional notes">
                                 </div>
                             </div>
                         `;
                         
                         setsContainer.appendChild(setItem);
                     } else {
                        // If not exists, create a new group
                         const groupDiv = document.createElement("div");
                         groupDiv.className = "exercise-group";
                         groupDiv.innerHTML = `
                             <div class="exercise-header">
                                 <div class="exercise-name">${exerciseName}</div>
                                 <div class="exercise-controls">
                                    <button class="btn btn-secondary" onclick="duplicateExerciseGroup(this)">📋 Duplicate exercise</button>
                                    <button class="btn btn-danger" onclick="deleteExerciseGroup(this)">🗑️ Delete exercise</button>
                                 </div>
                             </div>
                             <div class="exercise-sets">
                                 <div class="exercise-set-item">
                                     <div class="set-header">
                                        <div class="set-number">Set 1</div>
                                         <div class="set-controls">
                                              <button class="btn btn-success log-btn" onclick="logWorkout(this)">✅ Log</button>
                                              <button class="btn btn-secondary" onclick="duplicateSet(this)">📋 Duplicate</button>
                                              <button class="btn btn-danger" onclick="deleteSet(this)">🗑️ Delete</button>
                                         </div>
                                     </div>
                                     <div class="input-row">
                                         <div class="input-group">
                                              <label>Weight (kg)</label>
                                             <input type="number" class="weight" value="${weight}" min="0" step="0.5">
                                         </div>
                                         <div class="input-group">
                                              <label>Reps</label>
                                             <input type="number" class="reps" value="${reps}" min="1">
                                         </div>
                                         <div class="input-group">
                                              <label>Rest (s)</label>
                                             <input type="number" class="rest" value="${restSeconds}" min="0">
                                         </div>
                                         <div class="input-group">
                                              <label>Notes</label>
                                              <input type="text" class="notes" placeholder="Optional notes">
                                         </div>
                                     </div>
                                 </div>
                             </div>
                             <input type="hidden" class="exercise-id" value="${exerciseId}">
                         `;
                         
                         container.appendChild(groupDiv);
                     }
                     
                     totalSets++;
                     updateStats();
                     
                    // Show complete button
                     document.getElementById('completeWorkoutBtn').style.display = 'block';
                     

                     
                    // Close history panel
                     closeHistoryPanel();
                     
                    // Show success message
                    alert(`✅ Copied to today's workout!\nExercise: ${exerciseName}\nWeight: ${weight}kg\nReps: ${reps}`);
                 }, 100);
             }
         }
    </script>
</body>
</html>